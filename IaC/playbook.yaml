---
- name: Configure Rocky Linux 9 Server
  hosts: rocky_vm
  become: yes

  tasks:
    - name: Set the hostname
      ansible.builtin.hostname:
        name: "myhost.mydomain.tld"

    - name: Update /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 myhost.mydomain.tld"
        state: present

    - name: Install required packages
      ansible.builtin.dnf:
        name:
          - firewalld
          - nginx
          - certbot
        state: present

    - name: Start and enable firewalld
      ansible.builtin.systemd:
        name: firewalld
        enabled: yes
        state: started

    - name: Allow HTTP through firewall
      ansible.builtin.firewalld:
        service: http
        permanent: yes
        state: enabled
        immediate: yes

    - name: Allow HTTPS through firewall
      ansible.builtin.firewalld:
        service: https
        permanent: yes
        state: enabled
        immediate: yes

    - name: Allow SSH only from 1.2.3.4
      ansible.builtin.firewalld:
        rich_rule: 'rule family="ipv4" source address="1.2.3.4" service name="ssh" accept'
        permanent: yes
        state: enabled
        immediate: yes

    - name: Reload firewalld
      ansible.builtin.systemd:
        name: firewalld
        state: restarted

    - name: Create Nginx vhost config
      ansible.builtin.copy:
        dest: "/etc/nginx/conf.d/myhost.mydomain.tld.conf"
        content: |
          server {
              listen 80;
              server_name myhost.mydomain.tld;
              root /var/www/myhost;
              index index.html;

              location / {
                  try_files $uri $uri/ =404;
              }
          }
        owner: root
        group: root
        mode: '0644'

    - name: Create web root directory
      ansible.builtin.file:
        path: /var/www/myhost
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'

    - name: Create index.html
      ansible.builtin.copy:
        dest: "/var/www/myhost/index.html"
        content: "<h1>Welcome to myhost.mydomain.tld</h1>"
        owner: nginx
        group: nginx
        mode: '0644'

    - name: Restart Nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted
        enabled: yes
